<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Processing App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
        .result { color: #007BFF; }
    </style>
</head>
<body>
    <h1>Data Processing Application</h1>
    <button id="loadData">Load and Process Data</button>
    <pre id="output"></pre>
    
    <script>
        document.getElementById('loadData').addEventListener('click', async () => {
            const response = await fetch('data.csv'); // fetching the CSV data
            const text = await response.text();
            const data = text.split('\n').map(row => row.split(',')).slice(1); // parsing CSV
            
            // Assuming the header of the CSV is: date,units,price,region,product
            const df = data.map(row => ({
                date: new Date(row[0]),
                units: parseFloat(row[1]),
                price: parseFloat(row[2]),
                region: row[3],
                product: row[4]
            }));

            // Compute revenue
            df.forEach(item => item.revenue = item.units * item.price);

            // Compute row_count
            const row_count = df.length;

            // Count of distinct regions
            const regions_count = new Set(df.map(item => item.region)).size;

            // Top 3 products by revenue
            const topProducts = df.reduce((acc, curr) => {
                acc[curr.product] = (acc[curr.product] || 0) + curr.revenue;
                return acc;
            }, {});
            const top_n_products_by_revenue = Object.entries(topProducts).map(([product, revenue]) => ({ product, revenue }))
                .sort((a, b) => b.revenue - a.revenue).slice(0, 3);

            // Compute 7-day rolling revenue by region
            const dailyRevenue = {};
            df.forEach(item => {
                const key = item.region + '-' + item.date.toDateString();
                dailyRevenue[key] = (dailyRevenue[key] || 0) + item.revenue;
            });

            const rollingSummary = {};
            Object.keys(dailyRevenue).forEach(regionDate => {
                const [region, dateStr] = regionDate.split('-');
                const date = new Date(dateStr);
                const lastWeek = Object.keys(dailyRevenue).filter(key => {
                    const [r, d] = key.split('-');
                    return r === region && (new Date(d) >= new Date(date - 7 * 24 * 60 * 60 * 1000));
                });

                const rollingSum = lastWeek.reduce((sum, key) => sum + dailyRevenue[key], 0) / lastWeek.length;
                rollingSummary[region] = rollingSum;
            });

            // Prepare final result
            const result = {
                row_count,
                regions: regions_count,
                top_n_products_by_revenue,
                rolling_7d_revenue_by_region: rollingSummary
            };

            document.getElementById('output').innerText = JSON.stringify(result, null, 2);
        });
    </script>
</body>
</html>